name: Hexo Build & Deploy to Tencent COS

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.message, 'deploy')
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Hexo & Dependencies
        run: |
          npm install -g hexo-cli
          npm ci   # 比 npm install 更适合 CI 环境，更快更可靠

      - name: Build Hexo
        run: |
          hexo clean
          hexo generate

      - name: Verify build output
        run: ls -lh public/ | head -n 10

      - name: Install coscmd
        run: |
          pip3 install --user coscmd
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Configure & Upload to COS
        env:
          SECRET_ID:  ${{ secrets.TENCENT_COS_SECRET_ID }}
          SECRET_KEY: ${{ secrets.TENCENT_COS_SECRET_KEY }}
          BUCKET:     ${{ secrets.TENCENT_COS_BUCKET }}
          REGION:     ${{ secrets.TENCENT_COS_REGION }}
        run: |
          # 快速失败检查（防止 secrets 没配置导致后续无意义运行）
          : "${SECRET_ID:?SECRET_ID is required}"
          : "${SECRET_KEY:?SECRET_KEY is required}"
          : "${BUCKET:?BUCKET is required}"
          : "${REGION:?REGION is required}"

          # 配置 coscmd（-m 30 增加连接数）
          coscmd config -a "$SECRET_ID" -s "$SECRET_KEY" -b "$BUCKET" -r "$REGION" -m 30

          # 打印配置确认（已脱敏）
          echo "COS config preview (masked):"
          head -n 10 ~/.cos.conf | sed 's/secret_id = .*/secret_id = ***/; s/secret_key = .*/secret_key = ***/'

          # 同步上传（跳过相同文件 + 跳过 MD5 校验加速）
          coscmd upload -r -s --skipmd5 public/ /

          echo "COS sync upload completed"