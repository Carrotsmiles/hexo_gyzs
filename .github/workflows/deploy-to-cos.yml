name: Hexo Build & Deploy to Tencent COS

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.message, 'deploy')
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Hexo & Dependencies
        run: |
          npm install -g hexo-cli
          npm ci   # 比 npm install 更适合 CI 环境，更快更可靠

      - name: Build Hexo
        run: |
          hexo clean
          hexo generate

      - name: Verify build output
        run: ls -lh public/ | head -n 10

      - name: Install coscmd
        run: |
          pip3 install --user coscmd
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Upload to Tencent COS
        env:
          SECRET_ID: ${{ secrets.TENCENT_COS_SECRET_ID }}
          SECRET_KEY: ${{ secrets.TENCENT_COS_SECRET_KEY }}
          BUCKET: ${{ secrets.TENCENT_COS_BUCKET }}
          REGION: ${{ secrets.TENCENT_COS_REGION }}
        run: |
          # 配置（已成功，保留）
          coscmd config -a "$SECRET_ID" -s "$SECRET_KEY" -b "$BUCKET" -r "$REGION" -m 30
          
          # 调试：打印配置确认
          echo "Config file contents (masked):"
          cat ~/.cos.conf | sed 's/secret_id = .*/secret_id = ***/; s/secret_key = .*/secret_key = ***/'
          
          # 上传：-r 递归, -s sync 跳过相同文件, --skipmd5 跳过 MD5 计算加速
          coscmd upload -r -s --skipmd5 public/ /
          
          # 可选：如果想强制覆盖所有文件（不跳过），去掉 -s --skipmd5，用 -f
          # coscmd upload -r -f public/ /
          
          echo "COS upload completed successfully"