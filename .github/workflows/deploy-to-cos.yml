name: Hexo Build and Deploy to Tencent COS

on:
  push:
    branches: [ main ] # 主分支名称，根据实际调整

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: TENCENT_COS  # 若为环境级机密，必须指定
    # 添加 commit msg 过滤条件
    if: ${{ contains(github.event.head_commit.message, 'deploy')}} # 条件加在这里
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 拉取完整提交记录

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: |
          npm install -g hexo-cli
          npm install
      # - name: Debug - Check if secrets are available # 后续删除
      #   env:
      #     HAS_SECRET_ID: ${{ secrets.TENCENT_COS_SECRET_ID }}
      #     HAS_SECRET_KEY: ${{ secrets.TENCENT_COS_SECRET_KEY }}
      #     HAS_BUCKET: ${{ secrets.TENCENT_COS_BUCKET }}
      #     HAS_REGION: ${{ secrets.TENCENT_COS_REGION }}
      #   run: |
      #     echo "Secret ID available: $HAS_SECRET_ID"
      #     echo "Secret Key available: $HAS_SECRET_KEY"
      #     echo "Bucket available: $HAS_BUCKET"
      #     echo "Region available: $HAS_REGION"
      # - name: Strong Secret Debug # 增强验证环境参数获取。
      #   env:
      #     ID: ${{ secrets.TENCENT_COS_SECRET_ID }}
      #     KEY: ${{ secrets.TENCENT_COS_SECRET_KEY }}
      #     BUCKET: ${{ secrets.TENCENT_COS_BUCKET }}
      #     REGION: ${{ secrets.TENCENT_COS_REGION }}
      #   run: |
      #     echo "ID len: ${#ID}"
      #     echo "KEY len: ${#KEY}"
      #     echo "Bucket: ${BUCKET:-EMPTY}"
      #     echo "Region: ${REGION:-EMPTY}"
      # [ ${#ID} -eq 0 ] && echo "ID is empty/missing!" && exit 1

      # - name: Build and Deploy to COS
      #   env:
      #     # 从 GitHub Secrets 注入环境变量，匹配 _config.yml 中的占位符
      #     TENCENT_COS_SECRET_ID: ${{ secrets.TENCENT_COS_SECRET_ID }}
      #     TENCENT_COS_SECRET_KEY: ${{ secrets.TENCENT_COS_SECRET_KEY }}
      #     TENCENT_COS_BUCKET: ${{ secrets.TENCENT_COS_BUCKET }}
      #     TENCENT_COS_REGION: ${{ secrets.TENCENT_COS_REGION }}
      #   run: |
      #     hexo clean && hexo generate && hexo deploy # 一键编译+部署（使用 hexo-deploy-cos 插件）

      - name: Hexo Build
        # env:
        #   # 仅用于调试的输出环境变量
        #   DEBUG_BUCKET: ${{ secrets.TENCENT_COS_BUCKET }}
        #   DEBUG_REGION: ${{ secrets.TENCENT_COS_REGION }}
        run: |
          # echo "Target Bucket: $DEBUG_BUCKET"
          # echo "Target Region: $DEBUG_REGION"
          hexo clean
          hexo generate #--debug  # 添加调试信息
          # ls -la public/  # 确认生成的文件
      
      - name: Install coscmd
        run: pip3 install --user coscmd
        # 如果命令找不到，加下面一行（Actions runner 有时 PATH 没更新）
        # run: |
        #   pip3 install --user coscmd
        #   echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Upload to Tencent COS
        env:
          SECRET_ID: ${{ secrets.TENCENT_COS_SECRET_ID }}
          SECRET_KEY: ${{ secrets.TENCENT_COS_SECRET_KEY }}
          BUCKET: ${{ secrets.TENCENT_COS_BUCKET }}
          REGION: ${{ secrets.TENCENT_COS_REGION }}
        run: |
          # 配置（已成功，保留）
          coscmd config -a "$SECRET_ID" -s "$SECRET_KEY" -b "$BUCKET" -r "$REGION" -m 30
          
          # 调试：打印配置确认
          # echo "Config file contents (masked):"
          # cat ~/.cos.conf | sed 's/secret_id = .*/secret_id = ***/; s/secret_key = .*/secret_key = ***/'
          
          # 上传：-r 递归, -s sync 跳过相同文件, --skipmd5 跳过 MD5 计算加速
          coscmd upload -r -s --skipmd5 public/ /
          
          # 可选：如果想强制覆盖所有文件（不跳过），去掉 -s --skipmd5，用 -f
          # coscmd upload -r -f public/ /
          
          echo "COS upload completed successfully"